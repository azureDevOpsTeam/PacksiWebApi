<!DOCTYPE html>
<html>
<head>
    <title>SignalR Test</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>SignalR Chat Test</h1>
    <div id="status">Disconnected</div>
    <br>
    <div>
        <label>Receiver ID:</label>
        <input type="number" id="receiverId" value="12" />
        <br><br>
        <label>Message:</label>
        <input type="text" id="messageInput" placeholder="Enter your message" />
        <br><br>
        <button onclick="sendMessage()">ارسال پیام تست از SignalR</button>
        <button onclick="testAPI()">تست API</button>
    </div>
    <br>
    <div id="messages"></div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://api.packsi.net/chathub", {
                headers: {
                    "X-Telegram-Init-Data": "query_id=AAEfymc9AAAAAB_KZz0pgVLW&user=%7B%22id%22%3A1030212127%2C%22first_name%22%3A%22Shahram%22%2C%22last_name%22%3A%22%22%2C%22username%22%3A%22Shahram0weisy%22%2C%22language_code%22%3A%22en%22%2C%22allows_write_to_pm%22%3Atrue%2C%22photo_url%22%3A%22https%3A%5C%2F%5C%2Ft.me%5C%2Fi%5C%2Fuserpic%5C%2F320%5C%2FEVbiVIJZP-ipzuxmiuKkh1k1-dJF0U16tjKJdfQM7M4.svg%22%7D&auth_date=1757184054&signature=H"
                }
            })
            .build();

        // Event handlers
        connection.on("MessageSent", function (message) {
            const div = document.getElementById("messages");
            div.innerHTML += `<p><strong>Sent:</strong> ${JSON.stringify(message)}</p>`;
        });

        connection.on("MessageReceived", function (message) {
            const div = document.getElementById("messages");
            div.innerHTML += `<p><strong>Received:</strong> ${JSON.stringify(message)}</p>`;
        });

        connection.on("Error", function (error) {
            const div = document.getElementById("messages");
            div.innerHTML += `<p style="color: red;"><strong>Error:</strong> ${error}</p>`;
        });

        // Connection events
        connection.onclose(function () {
            document.getElementById("status").innerText = "Disconnected";
            document.getElementById("status").style.color = "red";
        });

        connection.onreconnecting(function () {
            document.getElementById("status").innerText = "Reconnecting...";
            document.getElementById("status").style.color = "orange";
        });

        connection.onreconnected(function () {
            document.getElementById("status").innerText = "Connected";
            document.getElementById("status").style.color = "green";
        });

        // Start connection
        connection.start().then(function () {
            document.getElementById("status").innerText = "Connected";
            document.getElementById("status").style.color = "green";
            console.log("SignalR Connected");
        }).catch(function (err) {
            document.getElementById("status").innerText = "Connection Failed";
            document.getElementById("status").style.color = "red";
            console.error("SignalR Connection Error: ", err);
            document.getElementById("messages").innerHTML += `<p style="color: red;"><strong>Connection Error:</strong> ${err}</p>`;
        });

        // Send message function
        async function sendMessage() {
            const receiverId = parseInt(document.getElementById("receiverId").value);
            const content = document.getElementById("messageInput").value;
            
            if (!content.trim()) {
                alert("Please enter a message");
                return;
            }

            const messageDto = {
                receiverId: receiverId,
                content: content
            };

            try {
                await connection.invoke("SendMessage", messageDto);
                console.log("Message sent successfully");
                document.getElementById('status').innerHTML += '<br>پیام با موفقیت ارسال شد!';
            } catch (err) {
                console.error("Send Message Error: ", err);
                document.getElementById("messages").innerHTML += `<p style="color: red;"><strong>Send Error:</strong> ${err}</p>`;
                document.getElementById('status').innerHTML += '<br>خطا در ارسال پیام: ' + err;
            }

            document.getElementById("messageInput").value = "";
        }

        // Test API call
        async function testAPI() {
            try {
                const response = await fetch('https://api.packsi.net/api/miniapp/LiveChat/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': 'query_id=AAEfymc9AAAAAB_KZz0pgVLW&user=%7B%22id%22%3A1030212127%2C%22first_name%22%3A%22Shahram%22%2C%22last_name%22%3A%22%22%2C%22username%22%3A%22Shahram0weisy%22%2C%22language_code%22%3A%22en%22%2C%22allows_write_to_pm%22%3Atrue%2C%22photo_url%22%3A%22https%3A%5C%2F%5C%2Ft.me%5C%2Fi%5C%2Fuserpic%5C%2F320%5C%2FEVbiVIJZP-ipzuxmiuKkh1k1-dJF0U16tjKJdfQM7M4.svg%22%7D&auth_date=1757184054&signature=H'
                    },
                    body: JSON.stringify({
                        receiverId: 12,
                        content: 'تست API از HTML'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('status').innerHTML += '<br>API موفق: ' + JSON.stringify(result);
                } else {
                    document.getElementById('status').innerHTML += '<br>API خطا: ' + response.status + ' - ' + response.statusText;
                }
            } catch (err) {
                document.getElementById('status').innerHTML += '<br>خطا در API: ' + err;
            }
        }

        // Allow Enter key to send message
        document.getElementById("messageInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>